# Certificate Deduplication Guide

## Overview

The Certificate Management System includes comprehensive deduplication capabilities to handle proxy certificates and general certificate duplicates. Proxy certificates are dynamically generated by corporate proxies/TLS interception devices, creating multiple certificates with different serial numbers but identical logical identity (same CA, target, and expiration).

## Proxy Certificate Deduplication

### Problem

Proxy certificates are generated on-the-fly with different serial numbers and thumbprints, but share:
- Same CA issuer (proxy CA)
- Same common name (target domain)
- Same expiration date

This causes the database to treat them as separate certificates when they're essentially the same.

### Solution

The system automatically detects and merges duplicate proxy certificates during scanning, and provides manual deduplication scripts for cleaning existing duplicates.

### Automatic Deduplication

**Location**: `infra_mgmt/utils/proxy_certificate_deduplication.py`

The enhanced deduplication system is integrated into the certificate scanning process and automatically:
- Identifies proxy certificates by CA issuer (not serial numbers)
- Merges duplicates based on logical identity (CA + target + expiration)
- Preserves all related data (bindings, scans, tracking)
- Marks certificates as proxied with detailed information

### Manual Deduplication Scripts

#### Basic Script
**File**: `scripts/deduplication/proxy_certificate_deduplication.py`

Simple deduplication that merges certificates only (no related data migration).

```bash
# Dry run to see what would be done
python scripts/deduplication/proxy_certificate_deduplication.py --dry-run

# Perform deduplication
python scripts/deduplication/proxy_certificate_deduplication.py

# Use with specific database path
python scripts/deduplication/proxy_certificate_deduplication.py --db-path \\\\server\\share\\certificates.db
```

#### Advanced Script (Recommended)
**File**: `scripts/deduplication/proxy_certificate_deduplication_advanced.py`

Comprehensive deduplication that migrates all related data (bindings, scans, tracking).

```bash
# Dry run to see what would be done
python scripts/deduplication/proxy_certificate_deduplication_advanced.py --dry-run

# Perform deduplication with data migration
python scripts/deduplication/proxy_certificate_deduplication_advanced.py

# Force execution without confirmation
python scripts/deduplication/proxy_certificate_deduplication_advanced.py --force
```

### Detection Algorithm

Duplicate proxy certificates are identified by grouping them based on:

```python
group_key = f"{issuer_cn}|{cn}|{valid_until}"
```

This groups certificates that have:
- **Same CA issuer** (proxy CA)
- **Same common name** (target domain)
- **Same expiration date**

### Proxy CA Detection

Certificates are identified as proxy certificates if:

1. **Configured CA subjects** match (from `config.yaml`)
2. **Common proxy indicators** are found in the CA name:
   - `proxy`, `corporate`, `internal`, `firewall`, `gateway`
   - `bluecoat`, `zscaler`, `forcepoint`

### Configuration

Configure your proxy CA subjects in `config.yaml`:

```yaml
proxy_detection:
  enabled: true
  ca_subjects:
    - "Corporate Proxy CA"
    - "BlueCoat ProxySG CA"
    - "Zscaler Root CA"
    - "Forcepoint SSL CA"
  bypass_patterns:
    - "*.github.com"
    - "*.googleapis.com"
  bypass_external: false
```

### Merging Strategy

- **Keep the oldest certificate** (earliest `created_at`)
- **Remove newer duplicates**
- **Migrate all related data** to the kept certificate
- **Mark as proxied** with detailed information

### Safety Features

1. **Dry Run Mode**: Always run with `--dry-run` first to see what would be done
2. **Confirmation Prompts**: Interactive confirmation before making changes
3. **Transaction Safety**: Database transactions ensure atomic operations with rollback on errors
4. **Data Preservation**: All related data is migrated to kept certificates

### Data Integrity

**What Gets Migrated:**
- Certificate Bindings (host associations, ports, applications)
- Certificate Scans (scan history, status, dates)
- Certificate Tracking (change tracking, notes, status)

**What Gets Preserved:**
- Oldest certificate (earliest creation date)
- All related data from duplicate certificates
- Proxy detection information with merge details

**What Gets Removed:**
- Newer duplicate certificates only (after data migration)

## General Certificate Deduplication

**File**: `scripts/deduplication/general_certificate_deduplication.py`

For non-proxy certificate deduplication based on thumbprint or serial number.

```bash
# Find duplicates
python scripts/diagnostics/find_certificate_duplicates.py

# Deduplicate
python scripts/deduplication/general_certificate_deduplication.py --dry-run
python scripts/deduplication/general_certificate_deduplication.py
```

## Best Practices

1. **Always Test First**: Run with `--dry-run` before making changes
2. **Backup Database**: Create a backup before running deduplication
3. **Use Advanced Script**: Use the advanced script for production databases
4. **Monitor Results**: Check the summary after deduplication and verify data integrity
5. **Schedule Maintenance**: Run periodically to clean up new duplicates

## Troubleshooting

### No Duplicates Found
This is normal if you don't have proxy certificates or duplicates.

### Database Locked
Close any applications using the database and try again.

### Permission Errors
Check file permissions and ensure you have write access.

### Network Path Issues
Verify network connectivity and path accessibility for remote databases.

### Recovery

If something goes wrong, restore from backup:

```bash
# Restore from backup
cp data/certificates.db.backup.TIMESTAMP data/certificates.db
```

Verify data integrity:

```sql
-- Check that certificates still exist
SELECT COUNT(*) FROM certificates;

-- Check that bindings are intact
SELECT COUNT(*) FROM certificate_bindings;

-- Check proxy certificates
SELECT COUNT(*) FROM certificates WHERE proxied = 1;
```

## Integration

- **Works with Migration**: Run after database migration to clean up existing duplicates
- **Ongoing Maintenance**: Run periodically to clean up new duplicates
- **Application Integration**: No application changes required, works with existing proxy detection

